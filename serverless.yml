service: threatalytics-gpt-api

provider:
  name: aws
  runtime: python3.9
  stage: dev
  region: us-east-1
  environment:
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID, ''}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID, ''}
    USERS_TABLE: ThreatalyticsUsers
    SUBSCRIPTIONS_TABLE: ThreatalyticsPlans
    USAGE_TABLE: ThreatalyticsUsage
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY, ''}
    STRIPE_SECRET_NAME: threatalytics/stripe
    ADMIN_SECRET_KEY: ${env:ADMIN_SECRET_KEY, 'threatalytics-admin-secret-2025'}
    STRIPE_PRICE_ID_STARTER: ${env:STRIPE_PRICE_ID_STARTER, ''}
    STRIPE_PRICE_ID_PROFESSIONAL: ${env:STRIPE_PRICE_ID_PROFESSIONAL, ''}
    STRIPE_PRICE_ID_ENTERPRISE: ${env:STRIPE_PRICE_ID_ENTERPRISE, ''}
  
  iamRoleStatements:
    - Effect: Allow
      Action:
        - secretsmanager:GetSecretValue
      Resource: 
        - "arn:aws:secretsmanager:${self:provider.region}:${aws:accountId}:secret:threatalytics-openai-key-*"
        - "arn:aws:secretsmanager:${self:provider.region}:${aws:accountId}:secret:threatalytics/stripe-*"
        - "arn:aws:secretsmanager:${self:provider.region}:${aws:accountId}:secret:threatalytics/admin-*"
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:Query
        - dynamodb:DeleteItem
        - dynamodb:Scan
      Resource:
        - "arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/ThreatalyticsUsage"
        - "arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/ThreatalyticsPlans"
        - "arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/ThreatalyticsUsers"
        - "arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/ThreatalyticsConversations"
    - Effect: Allow
      Action:
        - cognito-idp:AdminInitiateAuth
        - cognito-idp:AdminCreateUser
        - cognito-idp:AdminSetUserPassword
        - cognito-idp:AdminGetUser
        - cognito-idp:AdminUserGlobalSignOut
      Resource: "arn:aws:cognito-idp:${self:provider.region}:${aws:accountId}:userpool/*"
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: "arn:aws:logs:${self:provider.region}:${aws:accountId}:log-group:/aws/lambda/threatalytics-gpt-api-${self:provider.stage}-*:*"
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
      Resource: "arn:aws:s3:::threatalytics-logs-${aws:accountId}/*"
    - Effect: Allow
      Action:
        - sns:Publish
      Resource: "arn:aws:sns:${self:provider.region}:${aws:accountId}:threatalytics-alerts"

  # Enable CloudTrail for audit logging
  trails:
    - name: threatalytics-trail
      s3BucketName: threatalytics-cloudtrail-${aws:accountId}
      includeGlobalServiceEvents: true
      isMultiRegionTrail: false
      enableLogFileValidation: true

apiKeys:
  - free:
      - name: free-tier-key
        description: Free tier API key
  - pro:
      - name: pro-tier-key
        description: Pro tier API key

usagePlan:
  - free:
      throttle:
        burstLimit: 5
        rateLimit: 10
      quota:
        limit: 500
        offset: 0
        period: MONTH
  - pro:
      throttle:
        burstLimit: 20
        rateLimit: 100
      quota:
        limit: 5000
        offset: 0
        period: MONTH

functions:
  analyze:
    handler: lambda_functions/analyze.lambda_handler
    events:
      - http:
          path: /analyze
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Api-Key
              - X-Amz-Date
              - Authorization
              - X-Amz-Security-Token
            allowCredentials: false
          private: true  # requires API key

  redact:
    handler: lambda_functions/redact.lambda_handler
    events:
      - http:
          path: /redact
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Api-Key
              - X-Amz-Date
              - Authorization
              - X-Amz-Security-Token
            allowCredentials: false
          private: true

  report:
    handler: lambda_functions/report.lambda_handler
    events:
      - http:
          path: /report
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Api-Key
              - X-Amz-Date
              - Authorization
              - X-Amz-Security-Token
            allowCredentials: false
          private: true

  drill:
    handler: lambda_functions/drill.lambda_handler
    events:
      - http:
          path: /drill
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Api-Key
              - X-Amz-Date
              - Authorization
              - X-Amz-Security-Token
            allowCredentials: false
          private: true

  stripe_webhook:
    handler: lambda_functions/stripe_webhook.lambda_handler
    events:
      - http:
          path: /stripe/webhook
          method: post

  demo:
    handler: lambda_functions/demo.lambda_handler
    events:
      - http:
          path: /demo
          method: post
          cors: true

  # NEW: Authentication endpoint
  auth:
    handler: lambda_functions/auth.lambda_handler
    events:
      - http:
          path: /auth
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  # NEW: Conversations endpoint
  conversations:
    handler: lambda_functions/conversations.lambda_handler
    events:
      - http:
          path: /conversations
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false
      - http:
          path: /conversations
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false
      - http:
          path: /conversations/{id}
          method: delete
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: false

  # NEW: Admin Authentication
  adminAuth:
    handler: lambda_functions/admin_auth.lambda_handler
    environment:
      ADMIN_SECRET_KEY: ${env:ADMIN_SECRET_KEY, 'threatalytics-admin-secret-2025'}
    events:
      - http:
          path: /admin/auth
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/auth
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true

  # NEW: Usage Tracking
  usageTracker:
    handler: lambda_functions/usage_tracker.lambda_handler
    events:
      - http:
          path: /usage
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /usage/track
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /usage/check
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true

  # NEW: Subscription Management
  subscriptionManager:
    handler: lambda_functions/subscription_manager.lambda_handler
    environment:
      STRIPE_PRICE_ID_STARTER: ${env:STRIPE_PRICE_ID_STARTER, 'price_starter'}
      STRIPE_PRICE_ID_PROFESSIONAL: ${env:STRIPE_PRICE_ID_PROFESSIONAL, 'price_professional'}
      STRIPE_PRICE_ID_ENTERPRISE: ${env:STRIPE_PRICE_ID_ENTERPRISE, 'price_enterprise'}
    events:
      - http:
          path: /subscription/create
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /subscription/status
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /subscription/cancel
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /subscription/portal
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true

  # Admin Dashboard API
  adminDashboard:
    handler: admin/admin-api2.lambda_handler
    environment:
      STRIPE_SECRET_NAME: threatalytics/stripe
    events:
      - http:
          path: /admin/dashboard/stats
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/users
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/users/recent
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/charts/revenue
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/charts/usage
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true
      - http:
          path: /admin/users/export
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
            allowCredentials: true

resources:
  Resources:
    UsageTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ThreatalyticsUsage
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    PlansTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ThreatalyticsPlans
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: subscription_id
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: subscription_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    # NEW: Users Table for authentication
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ThreatalyticsUsers
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    # NEW: Conversations Table
    ConversationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ThreatalyticsConversations
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: conversation_id
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: conversation_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    LogsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: threatalytics-logs-${aws:accountId}
        VersioningConfiguration:
          Status: Enabled
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        EncryptionConfiguration:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256

    AlertsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: threatalytics-alerts
        DisplayName: Threatalytics Security Alerts

    CloudTrailBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: threatalytics-cloudtrail-${aws:accountId}
        VersioningConfiguration:
          Status: Enabled
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

resources:
  # Include DynamoDB tables
  - ${file(resources-dynamodb.yml)}

plugins:
  - serverless-python-requirements